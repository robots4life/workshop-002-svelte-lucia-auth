<!DOCTYPE html><html><head>
      <title>README</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/user/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.10/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="sveltekit-workshop--liip-zurich-switzerland-2023-10-27">SvelteKit Workshop @ Liip Zurich Switzerland 2023-10-27 </h1>
<p>Location<br>
<strong><a href="https://www.liip.ch/en" target="_blank">https://www.liip.ch/en</a></strong></p>
<p>Event<br>
<strong><a href="https://www.meetup.com/sveltesocietyzurich/events/296854457/" target="_blank">https://www.meetup.com/sveltesocietyzurich/events/296854457/</a></strong></p>
<p>Repository<br>
<strong><a href="https://github.com/robots4life/workshop-002-svelte-lucia-auth" target="_blank">https://github.com/robots4life/workshop-002-svelte-lucia-auth</a></strong></p>
<h2 id="1-clone-repository">1. Clone Repository </h2>
<h5 id="prerequisites">Prerequisites </h5>
<p>You need to have <strong>Node</strong> v18.17.1 or higher and <strong>git</strong> installed.</p>
<p>Install Node with nvm<br>
<a href="https://github.com/nvm-sh/nvm" target="_blank">https://github.com/nvm-sh/nvm</a></p>
<p>Install git<br>
<a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git" target="_blank">https://git-scm.com/book/en/v2/Getting-Started-Installing-Git</a></p>
<h5 id="clone-repository">Clone Repository </h5>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> clone git@github.com:robots4life/workshop-002-svelte-lucia-auth.git
</code></pre><pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>gh repo clone robots4life/workshop-002-svelte-lucia-auth
</code></pre><p>The branch names are numbered in sequence starting with <code>001-branch-name</code>.</p>
<p>Go through the workshop by checking out the first branch <strong><code>git checkout 001-setup-sveltekit</code></strong> and continue from there.</p>
<p>ðŸ’¡ With tab completion on your terminal you can just type the next number and easily checkout the next branch without having to type the whole name of the next branch.</p>
<p><a href="https://en.wikipedia.org/wiki/Command-line_completion" target="_blank">https://en.wikipedia.org/wiki/Command-line_completion</a></p>
<h5 id="start-here">Start here. </h5>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 001-setup-sveltekit
</code></pre><h2 id="2-setup-sveltekit">2. Setup SvelteKit </h2>
<p>In addition to having the ready-made solution in this workshop repository you can code along in your own project.</p>
<p>Create a new folder and run this command in the terminal inside the new folder.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">npm</span> create svelte@latest
</code></pre><ul>
<li>choose current directory</li>
<li>choose Skeleton project</li>
<li>choose TypeScript</li>
<li>choose ESLint</li>
<li>choose Prettier</li>
</ul>
<p>That should create a default skeleton project in the folder.</p>
<p>Next install the packages.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">npm</span> <span class="token function">install</span>
</code></pre><p>You can run the development server to make sure everything works fine so far.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">npm</span> run dev
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 002-setup-app
</code></pre><h2 id="3-setup-basic-app-styles-layout-and-pages">3. Setup basic app styles, layout and pages </h2>
<p>Create an <strong>app.css</strong> file in the <strong>src</strong> folder with the following contents.</p>
<p><strong>src/app.css</strong></p>
<pre data-role="codeBlock" data-info="css" class="language-css css"><code><span class="token comment">/* https://andy-bell.co.uk/a-modern-css-reset/ START */</span>
<span class="token comment">/* Box sizing rules */</span>
<span class="token selector">*<span class="token punctuation">,</span>
*<span class="token pseudo-element">::before</span><span class="token punctuation">,</span>
*<span class="token pseudo-element">::after</span></span> <span class="token punctuation">{</span>
	<span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Remove default margin */</span>
<span class="token selector">body<span class="token punctuation">,</span>
h1<span class="token punctuation">,</span>
h2<span class="token punctuation">,</span>
h3<span class="token punctuation">,</span>
h4<span class="token punctuation">,</span>
p<span class="token punctuation">,</span>
figure<span class="token punctuation">,</span>
blockquote<span class="token punctuation">,</span>
dl<span class="token punctuation">,</span>
dd</span> <span class="token punctuation">{</span>
	<span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Remove list styles on ul, ol elements with a list role, which suggests default styling will be removed */</span>
<span class="token selector">ul<span class="token attribute"><span class="token punctuation">[</span><span class="token attr-name">role</span><span class="token operator">=</span><span class="token attr-value">'list'</span><span class="token punctuation">]</span></span><span class="token punctuation">,</span>
ol<span class="token attribute"><span class="token punctuation">[</span><span class="token attr-name">role</span><span class="token operator">=</span><span class="token attr-value">'list'</span><span class="token punctuation">]</span></span></span> <span class="token punctuation">{</span>
	<span class="token property">list-style</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Set core root defaults */</span>
<span class="token selector">html<span class="token pseudo-class">:focus-within</span></span> <span class="token punctuation">{</span>
	<span class="token property">scroll-behavior</span><span class="token punctuation">:</span> smooth<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Set core body defaults */</span>
<span class="token selector">body</span> <span class="token punctuation">{</span>
	<span class="token property">min-height</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">vh</span><span class="token punctuation">;</span>
	<span class="token property">text-rendering</span><span class="token punctuation">:</span> optimizeSpeed<span class="token punctuation">;</span>
	<span class="token property">line-height</span><span class="token punctuation">:</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* A elements that don't have a class get default styles */</span>
<span class="token selector">a<span class="token pseudo-class">:not</span><span class="token punctuation">(</span><span class="token attribute"><span class="token punctuation">[</span><span class="token attr-name">class</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
	<span class="token property">text-decoration-skip-ink</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Make images easier to work with */</span>
<span class="token selector">img<span class="token punctuation">,</span>
picture</span> <span class="token punctuation">{</span>
	<span class="token property">max-width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">;</span>
	<span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Inherit fonts for inputs and buttons */</span>
<span class="token selector">input<span class="token punctuation">,</span>
button<span class="token punctuation">,</span>
textarea<span class="token punctuation">,</span>
select</span> <span class="token punctuation">{</span>
	<span class="token property">font</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Remove all animations, transitions and smooth scroll for people that prefer not to see them */</span>
<span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">prefers-reduced-motion</span><span class="token punctuation">:</span> reduce<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
	<span class="token selector">html<span class="token pseudo-class">:focus-within</span></span> <span class="token punctuation">{</span>
		<span class="token property">scroll-behavior</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token selector">*<span class="token punctuation">,</span>
	*<span class="token pseudo-element">::before</span><span class="token punctuation">,</span>
	*<span class="token pseudo-element">::after</span></span> <span class="token punctuation">{</span>
		<span class="token property">animation-duration</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token unit">ms</span> <span class="token important">!important</span><span class="token punctuation">;</span>
		<span class="token property">animation-iteration-count</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token important">!important</span><span class="token punctuation">;</span>
		<span class="token property">transition-duration</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token unit">ms</span> <span class="token important">!important</span><span class="token punctuation">;</span>
		<span class="token property">scroll-behavior</span><span class="token punctuation">:</span> auto <span class="token important">!important</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* https://andy-bell.co.uk/a-modern-css-reset/ END */</span>

<span class="token selector">html</span> <span class="token punctuation">{</span>
	<span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token hexcode color">#002244</span><span class="token punctuation">;</span>
	<span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">blanchedalmond</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">body</span> <span class="token punctuation">{</span>
	<span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token unit">rem</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">body<span class="token punctuation">,</span>
form<span class="token punctuation">,</span>
input<span class="token punctuation">,</span>
button<span class="token punctuation">,</span>
a</span> <span class="token punctuation">{</span>
	<span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span>
	<span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">1.6</span><span class="token unit">rem</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">a</span> <span class="token punctuation">{</span>
	<span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">whitesmoke</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">a<span class="token pseudo-class">:hover</span></span> <span class="token punctuation">{</span>
	<span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">green</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Create a <strong>+layout.svelte</strong> file in the <strong>src/routes</strong> folder with following contents.</p>
<p><strong>src/routes/+layout.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword module keyword-import">import</span> <span class="token string">'../app.css'</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token punctuation">/&gt;</span></span>
</code></pre><p>Create 3 pages, <code>signup</code>, <code>login</code> and <code>profile</code>.</p>
<p>Create a <strong>signup</strong> folder in the <strong>src/routes</strong> folder.<br>
Create a <strong>login</strong> folder in the <strong>src/routes</strong> folder.<br>
Create a <strong>profile</strong> folder in the <strong>src/routes</strong> folder.</p>
<p>Create a <strong>+page.svelte</strong> and <strong>+page.server.ts</strong> file in each new page.</p>
<h3 id="signup-page"><strong>Signup Page</strong> </h3>
<p>Create a simple form to send <code>signup</code> data to the default form action on the server.</p>
<p><strong>src/routes/signup/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Log In With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Sign Up<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>signup<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>32<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your Username<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cyber.punk.9731<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your password<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12345678<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">form</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>signup<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
	<span class="token selector">form</span> <span class="token punctuation">{</span>
		<span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
		<span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
		<span class="token property">gap</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token unit">rem</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token selector">button</span> <span class="token punctuation">{</span>
		<span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>Create a default form action on the server that logs the sent data to the terminal.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#default-actions" target="_blank">https://kit.svelte.dev/docs/form-actions#default-actions</a></p>
<p><strong>src/routes/signup/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="login-page"><strong>Login Page</strong> </h3>
<p>Create a simple form to send <code>login</code> data to the default form action on the server.</p>
<p><strong>src/routes/login/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/signup<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Sign Up With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Log In<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>32<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your Username<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cyber.punk.9731<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your password<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12345678<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">form</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
	<span class="token selector">form</span> <span class="token punctuation">{</span>
		<span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
		<span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
		<span class="token property">gap</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token unit">rem</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token selector">button</span> <span class="token punctuation">{</span>
		<span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>Create a default form action on the server that logs the sent data to the terminal.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#default-actions" target="_blank">https://kit.svelte.dev/docs/form-actions#default-actions</a></p>
<p><strong>src/routes/login/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="profile-page"><strong>Profile Page</strong> </h3>
<p><strong>src/routes/profile/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Profile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Account Details<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Protected Route - User Specific Information<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><strong>src/routes/profile/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'PROFILE page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="root-page"><strong>Root Page</strong> </h3>
<p>Last not least, add links to these pages on the root page.</p>
<p><strong>src/routes/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/signup<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Sign Up With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Log In With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/profile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>View Profile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Welcome to SvelteKit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Visit <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://kit.svelte.dev<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>kit.svelte.dev<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> to read the documentation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 003-setup-prisma
</code></pre><h2 id="4-setup-prisma">4. Setup Prisma </h2>
<p>You are going to use Prisma with an SQLite database with SvelteKit.</p>
<p><a href="https://www.prisma.io/" target="_blank">https://www.prisma.io/</a></p>
<h3 id="41-add-prisma-extension-to-vs-code">4.1 Add Prisma extension to VS Code </h3>
<p>Add the Prisma extension to VS Code.</p>
<p>Extension id <code>Prisma.prisma</code></p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=Prisma.prisma" target="_blank">https://marketplace.visualstudio.com/items?itemName=Prisma.prisma</a></p>
<p>Create a new folder <code>.vscode</code> in your project.</p>
<p>Create a file <code>setings.json</code> inside that <code>.vscode</code> folder in your project.</p>
<p>Add these settings for the Prisma extension in that <code>settings.json</code> file. This formats your <code>schema.prisma</code> file on save.</p>
<p><strong>.vscode/settings.json</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
	<span class="token property">"[prisma]"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"editor.defaultFormatter"</span><span class="token operator">:</span> <span class="token string">"Prisma.prisma"</span><span class="token punctuation">,</span>
		<span class="token property">"editor.formatOnSave"</span><span class="token operator">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="42-install-prisma-cli">4.2. Install Prisma CLI </h3>
<p>Install the Prisma CLI as a development dependency in the project.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/command-reference#installation" target="_blank">https://www.prisma.io/docs/reference/api-reference/command-reference#installation</a></p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">npm</span> <span class="token function">install</span> prisma --save-dev
</code></pre><h3 id="43-setup-prisma-with-sqlite-database">4.3 Setup Prisma with SQLite Database </h3>
<p>Setup Prisma with the <code>init</code> command of the Prisma CLI and choose <code>sqlite</code> as database.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/command-reference#usage" target="_blank">https://www.prisma.io/docs/reference/api-reference/command-reference#usage</a></p>
<p>If you installed Prisma as a development dependency, you need to prefix the <code>prisma</code> command with your package runner.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/command-reference#run-prisma-init---datasource-provider-sqlite" target="_blank">https://www.prisma.io/docs/reference/api-reference/command-reference#run-prisma-init---datasource-provider-sqlite</a></p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>npx prisma init --datasource-provider sqlite
</code></pre><p>output ðŸ‘‰</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>âœ” Your Prisma schema was created at prisma/schema.prisma
  You can now <span class="token function">open</span> it <span class="token keyword keyword-in">in</span> your favorite editor.

warn You already have a .gitignore file. Don't forget to <span class="token function">add</span> <span class="token variable"><span class="token variable">`</span>.env<span class="token variable">`</span></span> <span class="token keyword keyword-in">in</span> it to not commit any private information.

Next steps:
<span class="token number">1</span>. Set the DATABASE_URL <span class="token keyword keyword-in">in</span> the .env <span class="token function">file</span> to point to your existing database. If your database has no tables yet, <span class="token builtin class-name">read</span> https://pris.ly/d/getting-started
<span class="token number">2</span>. Run prisma db pull to turn your database schema into a Prisma schema.
<span class="token number">3</span>. Run prisma generate to generate the Prisma Client. You can <span class="token keyword keyword-then">then</span> start querying your database.

More information <span class="token keyword keyword-in">in</span> our documentation:
https://pris.ly/d/getting-started
</code></pre><h3 id="44-setup-prisma-schema-for-username-and-password-authentication-with-lucia">4.4 Setup Prisma Schema for Username and Password Authentication with Lucia </h3>
<p>The default Prisma schema for Lucia has an <code>User</code>, a <code>Key</code> and a <code>Session</code> model.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/database-adapters/prisma#prisma-schema" target="_blank">https://lucia-auth.com/database-adapters/prisma#prisma-schema</a></p>
<p>â— Since you are going to to do authentication with a <code>username</code> and <code>password</code> you need to add a <code>username</code> field to your <code>User</code> model. â—</p>
<p>The <code>username</code> field has to be of type <code>String</code> and be unique, <code>@unique</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit/#update-your-database" target="_blank">https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit/#update-your-database</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#unique" target="_blank">https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#unique</a></p>
<p><a href="https://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank">https://en.wikipedia.org/wiki/Basic_access_authentication</a></p>
<p><a href="https://www.loginradius.com/blog/identity/best-practices-username-password-authentication/" target="_blank">https://www.loginradius.com/blog/identity/best-practices-username-password-authentication/</a></p>
<p>In this Prisma schme the <code>User</code> model has a <code>username</code> field.</p>
<p><strong>prisma/schema.prisma</strong></p>
<pre data-role="codeBlock" data-info="prisma" class="language-prisma prisma"><code>// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @unique
  username     String    @unique
  auth_session Session[]
  key          Key[]
}

model Session {
  id             String @id @unique
  user_id        String
  active_expires BigInt
  idle_expires   BigInt
  user           User   @relation(references: [id], fields: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model Key {
  id              String  @id @unique
  hashed_password String?
  user_id         String
  user            User    @relation(references: [id], fields: [user_id], onDelete: Cascade)

  @@index([user_id])
}
</code></pre><h3 id="45-generate-sqlite-database-with-prisma-schema">4.5 Generate SQLite Database with Prisma Schema </h3>
<p>Now it is time to generate the SQLite database according to the Prisma Schema.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/getting-started/quickstart#3-run-a-migration-to-create-your-database-tables-with-prisma-migrate" target="_blank">https://www.prisma.io/docs/getting-started/quickstart#3-run-a-migration-to-create-your-database-tables-with-prisma-migrate</a></p>
<p>Run the following command in your terminal to create the SQLite database and the</p>
<ul>
<li><strong>User</strong></li>
<li><strong>Session</strong></li>
<li><strong>Key</strong></li>
</ul>
<p><strong>tables</strong> represented by your <strong>models</strong> and defined in in your <strong>Prisma Schema</strong>.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>npx prisma migrate dev <span class="token parameter variable">--name</span> init
</code></pre><p>This command does two things.</p>
<ol>
<li>It creates a new SQL migration file for this migration in the prisma/migrations directory.</li>
<li>It runs the SQL migration file against the database.</li>
</ol>
<p>Because the SQLite database file didn't exist before, the command also created the file inside the prisma directory with the name <code>dev.db</code> as defined via the environment variable in the <code>.env</code> file.</p>
<p>output ðŸ‘‰</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource <span class="token string">"db"</span><span class="token builtin class-name">:</span> SQLite database <span class="token string">"dev.db"</span> at <span class="token string">"file:./dev.db"</span>

SQLite database dev.db created at file:./dev.db

Applying migration <span class="token variable"><span class="token variable">`</span>20231025151831_init<span class="token variable">`</span></span>

The following migration<span class="token punctuation">(</span>s<span class="token punctuation">)</span> have been created and applied from new schema changes:

migrations/
  â””â”€ 20231025151831_init/
    â””â”€ migration.sql

Your database is now <span class="token keyword keyword-in">in</span> <span class="token function">sync</span> with your schema.

âœ” Generated Prisma Client <span class="token punctuation">(</span>v5.5.1<span class="token punctuation">)</span> to ./node_modules/@prisma/client <span class="token keyword keyword-in">in</span> 110ms
</code></pre><h3 id="45-centralize-the-prisma-client">4.5 Centralize the Prisma Client </h3>
<p>It is common practice to create a Singleton of the Prisma client to use throughout your app.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/instantiate-prisma-client" target="_blank">https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/instantiate-prisma-client</a></p>
<p>In addition and during development you can examine various logs from Prisma.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/logging" target="_blank">https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/logging</a></p>
<p><a href="https://refactoring.guru/design-patterns/singleton" target="_blank">https://refactoring.guru/design-patterns/singleton</a></p>
<p>Create a new folder <code>server</code> in the folder <code>src/lib</code>.</p>
<p>Create a new file <code>prisma.ts</code> in the folder <code>src/lib/server</code>.</p>
<p><strong>src/lib/server/prisma.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> PrismaClient <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@prisma/client'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> db <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">PrismaClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	log<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 004-setup-lucia
</code></pre><h2 id="5-setup-lucia">5. Setup Lucia </h2>
<p>You are going to use Lucia for authentication with username and password.</p>
<p><a href="https://lucia-auth.com/" target="_blank">https://lucia-auth.com/</a></p>
<h3 id="51-install-lucia-and-install-adapter-prisma-for-lucia">5.1 Install Lucia and install Adapter Prisma for Lucia </h3>
<p>ðŸ’¡ <a href="https://lucia-auth.com/getting-started/sveltekit" target="_blank">https://lucia-auth.com/getting-started/sveltekit</a></p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">npm</span> <span class="token function">install</span> lucia
</code></pre><p>ðŸ’¡ <a href="https://lucia-auth.com/database-adapters/prisma#installation" target="_blank">https://lucia-auth.com/database-adapters/prisma#installation</a></p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">npm</span> <span class="token function">install</span> @lucia-auth/adapter-prisma
</code></pre><h3 id="52-initialize-lucia">5.2 Initialize Lucia </h3>
<p>ðŸ’¡ <a href="https://lucia-auth.com/getting-started/sveltekit#initialize-lucia" target="_blank">https://lucia-auth.com/getting-started/sveltekit#initialize-lucia</a></p>
<p>Import <code>lucia()</code> from <code>lucia</code> and initialize it in its own module (file).</p>
<p>Export <code>auth</code> and its type as <code>Auth</code>. Make sure to pass the <code>sveltekit()</code> middleware.</p>
<p>Create a new folder <code>server</code> in the folder <code>src/lib</code>.</p>
<p>Create a new file <code>lucia.ts</code> in the folder <code>src/lib/server</code>.</p>
<p>Weâ€™ll expose the userâ€™s <code>username</code> to the <code>User</code> object by defining <code>getUserAttributes</code>.</p>
<p>For this you use the user attribute, <code>username</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/basics/configuration#getuserattributes" target="_blank">https://lucia-auth.com/basics/configuration#getuserattributes</a></p>
<p><strong>src/lib/server/lucia.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> lucia <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> sveltekit <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'lucia/middleware'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> dev <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$app/environment'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> prisma <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@lucia-auth/adapter-prisma'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/prisma'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> auth <span class="token operator">=</span> <span class="token function">lucia</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	env<span class="token operator">:</span> dev <span class="token operator">?</span> <span class="token string">'DEV'</span> <span class="token operator">:</span> <span class="token string">'PROD'</span><span class="token punctuation">,</span>
	middleware<span class="token operator">:</span> <span class="token function">sveltekit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	adapter<span class="token operator">:</span> <span class="token function">prisma</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token punctuation">{</span>
		user<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token comment">// model User {}</span>
		key<span class="token operator">:</span> <span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token comment">// model Key {}</span>
		session<span class="token operator">:</span> <span class="token string">'session'</span> <span class="token comment">// model Session {}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function-variable function">getUserAttributes</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
			username<span class="token operator">:</span> data<span class="token punctuation">.</span>username
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-type">type</span> <span class="token class-name">Auth</span> <span class="token operator">=</span> <span class="token keyword keyword-typeof">typeof</span> auth<span class="token punctuation">;</span>
</code></pre><h3 id="53-setup-types-for-lucia">5.3. Setup Types for Lucia </h3>
<p>ðŸ’¡ <a href="https://lucia-auth.com/getting-started/sveltekit#set-up-types" target="_blank">https://lucia-auth.com/getting-started/sveltekit#set-up-types</a></p>
<p>In your <code>src/app.d.ts</code> file, declare a <code>Lucia</code> namespace. The import path for <code>Auth</code> is where you initialized <code>lucia()</code>.</p>
<p>Set the type for the user attribute you added to the Lucia configuration, <code>username</code>.</p>
<p><strong>src/app.d.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// See https://kit.svelte.dev/docs/types#app</span>
<span class="token comment">// for information about these interfaces</span>

<span class="token comment">// https://lucia-auth.com/getting-started/sveltekit#set-up-types</span>
<span class="token keyword keyword-declare">declare</span> global <span class="token punctuation">{</span>
	<span class="token keyword keyword-namespace">namespace</span> App <span class="token punctuation">{</span>
		<span class="token comment">// interface Error {}</span>
		<span class="token keyword keyword-interface">interface</span> <span class="token class-name">Locals</span> <span class="token punctuation">{</span>
			auth<span class="token operator">:</span> <span class="token keyword keyword-import">import</span><span class="token punctuation">(</span><span class="token string">'lucia'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>AuthRequest<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// interface PageData {}</span>
		<span class="token comment">// interface Platform {}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;reference types="lucia" /&gt;</span>
<span class="token keyword keyword-declare">declare</span> global <span class="token punctuation">{</span>
	<span class="token keyword keyword-namespace">namespace</span> Lucia <span class="token punctuation">{</span>
		<span class="token keyword keyword-type">type</span> <span class="token class-name">Auth</span> <span class="token operator">=</span> <span class="token keyword keyword-import">import</span><span class="token punctuation">(</span><span class="token string">'$lib/server/lucia'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Auth<span class="token punctuation">;</span>
		<span class="token keyword keyword-type">type</span> <span class="token class-name">DatabaseUserAttributes</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token comment">// required fields (i.e. id) should not be defined here</span>
			username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-type">type</span> <span class="token class-name">DatabaseSessionAttributes</span> <span class="token operator">=</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">never</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-export">export</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="54-setup-hooks-to-store-authrequest-on-the-localsauth-object">5.4 Setup Hooks to store <code>Auth.request()</code> on the <code>locals.auth</code> Object </h3>
<p>ðŸ’¡ <a href="https://lucia-auth.com/getting-started/sveltekit#set-up-hooks" target="_blank">https://lucia-auth.com/getting-started/sveltekit#set-up-hooks</a></p>
<p><strong>This is optional but highly recommended</strong>.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/hooks#server-hooks-handle" target="_blank">https://kit.svelte.dev/docs/hooks#server-hooks-handle</a></p>
<p>Create a new <code>handle()</code> hook that stores <code>AuthRequest</code> on the <code>locals.auth</code> object.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest</a></p>
<p><code>locals.auth</code> will store the <code>Auth.request()</code> methods <code>setSession()</code>, <code>validate()</code> and <code>validateBearerToken()</code>.</p>
<p>Create a new file <code>hooks.server.ts</code> in the <code>src</code> folder.</p>
<p>â— Note, there is no <code>+</code> in front of the file name <strong><code>hooks.server.ts</code></strong>. â—</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/types#app-locals" target="_blank">https://kit.svelte.dev/docs/types#app-locals</a></p>
<p>Note that you can access the <code>locals</code> object where you now store the <code>auth</code> methods when creating the <code>hooks.server.ts</code> file.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#loading-data" target="_blank">https://kit.svelte.dev/docs/form-actions#loading-data</a></p>
<p>To access the <code>locals</code> object in a <code>load</code> function of a page or in a default or named <code>form action</code> of a page you need to add it as parameter to the function.</p>
<p>You will see an example of how this is done in just a moment.</p>
<p>You can unpack properties from objects passed as a function parameter. These properties may then be accessed within the function body.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment#unpacking_properties_from_objects_passed_as_a_function_parameter" target="_blank">MDN reference -&gt; Unpacking properties from objects passed as a function parameter</a></p>
<p><strong>src/hooks.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Handle <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> handle<span class="token operator">:</span> <span class="token function-variable function">Handle</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> event<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// you can pass `event` because you used the SvelteKit middleware</span>
	event<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>auth <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 005-signup-user
</code></pre><h2 id="6-signup-user">6. Signup User </h2>
<p>In the next steps you are going to add the code needed to create a new user in the database.</p>
<p>All of this is done server-side in the <strong>src/routes/signup/+page.server.ts</strong> file.</p>
<h3 id="61-do-a-basic-check-with-the-received-form-values">6.1 Do a basic check with the received form values </h3>
<p>If the request couldn't be processed because of invalid data, you can return validation errors - along with the previously submitted form values - back to the user, so that they can try again.</p>
<p>The <code>fail</code> function lets you return an HTTP status code (typically <code>400</code> or <code>422</code>, in the case of validation errors) along with the data.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#anatomy-of-an-action-validation-errors" target="_blank">https://kit.svelte.dev/docs/form-actions#anatomy-of-an-action-validation-errors</a></p>
<p><strong>src/routes/signup/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>To display the returned error <code>message</code> on the <code>signup</code> page you <code>export</code> the <code>form</code> property on the page and work with the error.</p>
<p>Use the Svelte <code>class</code> directive to trigger the <code>.error</code> class on the <code>form</code> property.</p>
<p>ðŸ’¡ <a href="https://learn.svelte.dev/tutorial/classes" target="_blank">https://learn.svelte.dev/tutorial/classes</a></p>
<p>â— Change the form values to something that will break the validation to see the server-side check kick in. â—</p>
<p><strong>src/routes/signup/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token comment">// export the form property on this page to show the return value of the form action on the page</span>
	<span class="token keyword module keyword-import">import</span> type <span class="token punctuation">{</span> <span class="token maybe-class-name">ActionData</span> <span class="token punctuation">}</span> <span class="token keyword module keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
	<span class="token keyword module keyword-export">export</span> <span class="token keyword keyword-let">let</span> <span class="token literal-property property">form</span><span class="token operator">:</span> <span class="token maybe-class-name">ActionData</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Log In With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Sign Up<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>signup<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>32<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your Username<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cyber.punk.9731<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your password<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12345678<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">form</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>signup<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- show the return value from the form action --&gt;</span>
<span class="token comment">&lt;!-- use the Svelte class directive to trigger the CSS .error class --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> <span class="token attr-name"><span class="token namespace">class:</span>error</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{form?.message}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{JSON.stringify(form, null, 2)}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
	<span class="token selector">form</span> <span class="token punctuation">{</span>
		<span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
		<span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
		<span class="token property">gap</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token unit">rem</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token selector">button</span> <span class="token punctuation">{</span>
		<span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token selector"><span class="token class">.error</span></span> <span class="token punctuation">{</span>
		<span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token color">darkred</span><span class="token punctuation">;</span>
		<span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">lightgoldenrodyellow</span><span class="token punctuation">;</span>
		<span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span>
		<span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span> solid <span class="token color">darkslateblue</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="62-add-a-new-user-to-the-database">6.2 Add a new User to the Database </h3>
<p>After you have done a basic check with the received form values you can create a new user.</p>
<p>Users can be created with <code>Auth.createUser()</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/basics/users" target="_blank">https://lucia-auth.com/basics/users</a></p>
<p>This will create a new user, and, if <code>key</code> is defined, a new <code>key</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/basics/keys" target="_blank">https://lucia-auth.com/basics/keys</a></p>
<p>Keys represent the relationship between a user and a reference to that user.</p>
<p>While the user id is the primary way of identifying a user, there are other ways your app may reference a user during the authentication step such as by their <code>username</code>, <code>email</code>, or Github user id.</p>
<p>These identifiers, be it from a user input or an external source, are provided by a <strong>provider</strong>, identified by a <code>providerId</code>.</p>
<p>The unique id for that user within the <strong>provider</strong> is the <code>providerUserId</code>.</p>
<p>The unique combination of the provider id and provider user id makes up a <code>key</code>.</p>
<p>The <code>key</code> here defines the connection between the user and the provided unique <code>email</code> (<code>providerUserId</code>) when using the <code>email</code> &amp; <code>password</code> authentication method (<code>providerId</code>).</p>
<p>Weâ€™ll also store the password in the <code>key</code>.</p>
<p>This <code>key</code> will be used to get the user and validate the password when logging them in.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/basics/users/#create-users" target="_blank">https://lucia-auth.com/basics/users/#create-users</a></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-const">const</span> user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	key<span class="token operator">:</span> <span class="token punctuation">{</span>
		providerId<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token comment">// auth method</span>
		providerUserId<span class="token operator">:</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// unique id when using "username" auth method</span>
		password <span class="token comment">// hashed by Lucia</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
		username
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>The form action so far has this code. By returning the <code>user</code> after <code>await auth.createUser()</code> we can see the created user on the signup page.</p>
<p>â— Do not do this in production in a real application. This is done here for you to see the result fo creating a new user in the database. â—</p>
<p><strong>src/routes/signup/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createuser</span>
			<span class="token comment">// 1. create a new user</span>
			<span class="token keyword keyword-const">const</span> user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				key<span class="token operator">:</span> <span class="token punctuation">{</span>
					providerId<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token comment">// auth method</span>
					providerUserId<span class="token operator">:</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// unique id when using "username" auth method</span>
					password <span class="token comment">// hashed by Lucia</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
					username
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// let's return the created user back to the sign up page for now</span>
			<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> satisfies Actions<span class="token punctuation">;</span>
</code></pre><p>On the <code>signup</code> page you can now see the data for the created <code>user</code> returned to the page in the <code>form</code> property, the returned value from the server-side default form action.</p>
<img src="static/Screenshot_20231026_151853.png">
<p>You can also see the created user in database with <strong>Prisma Studio</strong>.</p>
<p>Start Prisma Studio.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>npx prisma studio
</code></pre><p>ðŸ’¡ <a href="https://www.prisma.io/blog/prisma-studio-3rtf78dg99fe" target="_blank">https://www.prisma.io/blog/prisma-studio-3rtf78dg99fe</a></p>
<p>Open <a href="http://localhost:5555/" target="_blank">http://localhost:5555/</a> if it is not automatically opened in your browser after this command.</p>
<img src="static/Screenshot_20231026_152400.png">
<p>Click on <code>User</code> to see the data for the user.</p>
<img src="static/Screenshot_20231026_152512.png">
<p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 006-create-user-session
</code></pre><h3 id="63-create-a-user-session">6.3 Create a User Session </h3>
<p>Sessions can be created with <code>Auth.createSession()</code> and can be stored as a cookie.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/auth#createsession" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</a></p>
<p>After successfully creating a user, weâ€™ll create a new session with <code>Auth.createSession()</code> and store it as a cookie with <code>AuthRequest.setSession()</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</a></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
<span class="token comment">// 2. create a new session once the user is created</span>
<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	userId<span class="token operator">:</span> user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
	attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>â— Remember when you setup <code>hooks.server.ts</code> and stored the <code>Auth.request()</code> methods on the <code>locals.auth</code> object ? â—</p>
<p>ðŸ‘‰ <a href="https://github.com/robots4life/workshop-002-svelte-lucia-auth/tree/005-signup-user#54-setup-hooks-to-store-authrequest-on-the-localsauth-object" target="_blank">5.4 Setup Hooks to store Auth.request() on the locals.auth Object</a></p>
<p>Note that you can access the <code>locals</code> object where you stored the <code>auth</code> methods when creating the <code>hooks.server.ts</code> file.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#loading-data" target="_blank">https://kit.svelte.dev/docs/form-actions#loading-data</a></p>
<p>To access the <code>locals</code> object in a <code>load</code> function of a page or in a default or named <code>form action</code> of a page you need to add it as parameter to the function.</p>
<p>You can unpack properties from objects passed as a function parameter. These properties may then be accessed within the function body.</p>
<p>Here you see <code>locals</code> being added as a function parameter so that it can be accessed in the function body, in this case the <code>form action</code>.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment#unpacking_properties_from_objects_passed_as_a_function_parameter" target="_blank">MDN reference -&gt; Unpacking properties from objects passed as a function parameter</a></p>
<p><strong>src/routes/signup/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createuser</span>
			<span class="token comment">// 1. create a new user</span>
			<span class="token keyword keyword-const">const</span> user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				key<span class="token operator">:</span> <span class="token punctuation">{</span>
					providerId<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token comment">// auth method</span>
					providerUserId<span class="token operator">:</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// unique id when using "username" auth method</span>
					password <span class="token comment">// hashed by Lucia</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
					username
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
			<span class="token comment">// 2. create a new session once the user is created</span>
			<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				userId<span class="token operator">:</span> user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
			<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
			locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// let's return the created user back to the sign up page for now</span>
			<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> satisfies Actions<span class="token punctuation">;</span>
</code></pre><p>Start <strong>Prisma Studio</strong> if it is not running already.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>npx prisma studio
</code></pre><p>Go to your Prisma Studio on <a href="http://localhost:5555/" target="_blank">http://localhost:5555/</a>, select the <code>User</code> row and hit <code>Delete 1 record</code> to delete the previously created user.</p>
<p>If you have any other users then delete all those as well so that you have no records in the database.</p>
<p>Go to the <code>signup</code> page and now let's create a new user and a session stored as a cookie for that new user, submit the form.</p>
<p>Again, the SvelteKit default <code>form action</code> returns the newly created <code>user</code> object to the page.</p>
<p>You should now see a new user and a new session.</p>
<img src="static/Screenshot_20231026_155513.png">
<p>Click on <code>User</code> to see the created user and click on <code>Session</code> to the current session for that user.</p>
<p>The created <code>User</code>.</p>
<img src="static/Screenshot_20231026_155613.png">
<p>The created <code>Session</code>.</p>
<img src="static/Screenshot_20231026_155653.png">
<p>Now let's have a look at the created session cookie in the browser development tools.</p>
<img src="static/Screenshot_20231026_155759.png">
<p>Well done, you just created a new user and a session for that new user that is stored as a cookie, all this with a SvelteKit form default action, using Lucia with Prisma and Sqlite. ðŸŽ‰</p>
<p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 007-handle-errors
</code></pre><h3 id="64-handle-errors">6.4 Handle Errors </h3>
<p>Lucia throws 2 types of errors: <code>LuciaError</code> and database errors from the database driver or ORM youâ€™re using.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/modules/main#luciaerror" target="_blank">https://lucia-auth.com/reference/lucia/modules/main#luciaerror</a></p>
<p>Most database related errors, such as connection failure, duplicate values, and foreign key constraint errors, are thrown as is. These need to be handled as if you were using just the driver/ORM.</p>
<p>Find details about how Prisma does error handling.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/concepts/components/prisma-client/handling-exceptions-and-errors" target="_blank">https://www.prisma.io/docs/concepts/components/prisma-client/handling-exceptions-and-errors</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference#error-codes" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference#error-codes</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/error-formatting" target="_blank">https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/error-formatting</a></p>
<p>Let's try and log a <code>PrismaClientKnownRequestError</code> with Prisma.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference#prismaclientknownrequesterror" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference#prismaclientknownrequesterror</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference#p2002" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference#p2002</a></p>
<p><strong>src/lib/server/prisma.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> Prisma<span class="token punctuation">,</span> PrismaClient <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@prisma/client'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> db <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">PrismaClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	log<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> PrismaError <span class="token operator">=</span> Prisma<span class="token punctuation">;</span>
</code></pre><p><strong>src/routes/signup/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> LuciaError <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> PrismaError <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/prisma'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createuser</span>
			<span class="token comment">// 1. create a new user</span>
			<span class="token keyword keyword-const">const</span> user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				key<span class="token operator">:</span> <span class="token punctuation">{</span>
					providerId<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token comment">// auth method</span>
					providerUserId<span class="token operator">:</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// unique id when using "username" auth method</span>
					password <span class="token comment">// hashed by Lucia</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
					username
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
			<span class="token comment">// 2. create a new session once the user is created</span>
			<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				userId<span class="token operator">:</span> user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
			<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
			locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// let's return the created user back to the sign up page for now</span>
			<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//</span>
			<span class="token comment">// Prisma error</span>
			<span class="token comment">// https://www.prisma.io/docs/reference/api-reference/error-reference#prismaclientknownrequesterror</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>e <span class="token keyword keyword-instanceof">instanceof</span> <span class="token class-name">PrismaError</span><span class="token punctuation">.</span>PrismaClientKnownRequestError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">//</span>
				<span class="token comment">// https://www.prisma.io/docs/reference/api-reference/error-reference#p2002</span>
				<span class="token comment">// The .code property can be accessed in a type-safe manner</span>
				<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'P2002'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unique constraint failed on the </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token operator">?.</span>meta<span class="token operator">?.</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e : '</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e.meta : '</span> <span class="token operator">+</span> e<span class="token operator">?.</span>meta<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e.meta.target : '</span> <span class="token operator">+</span> e<span class="token operator">?.</span>meta<span class="token operator">?.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// return the error to the page with SvelteKit's fail function</span>
					<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unique constraint failed on the field </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token operator">?.</span>meta<span class="token operator">?.</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// Lucia error</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/modules/main#luciaerror</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>e <span class="token keyword keyword-instanceof">instanceof</span> <span class="token class-name">LuciaError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Lucia error</span>
				<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// throw any other error that is not caught by above conditions</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> satisfies Actions<span class="token punctuation">;</span>
</code></pre><p>If you try to sign up with an existing user you should see an error message be displayed on the <code>signup</code> page.</p>
<img src="static/Screenshot_20231026_162405.png">
<p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 008-redirect-authenticated-user
</code></pre><h2 id="7-redirect-an-authenticated-user">7. Redirect an Authenticated User </h2>
<p>After a new user has successfully registered a new <code>username</code> on the <code>signup</code> page it makes sense to <code>redirect</code> that user to another page of the app instead of staying on the <code>signup</code> page.</p>
<p>For example we could redirect the new user to their personal <code>profile</code> page. Also, if a user tries to go back to the <code>signup</code> page we should redirect them to their <code>profile</code> page instead.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit#redirect-authenticated-users" target="_blank">https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit#redirect-authenticated-users</a></p>
<p>In the previous step we did create a new user and a session for that user stored in a cookie. We will use the session stored in that cookie to authenticate the user on every new request to the app.</p>
<p>You can validate requests by creating a new <code>AuthRequest</code> instance with <code>Auth.handleRequest()</code>, which is stored in <code>locals.auth </code> and calling <code>AuthRequest.validate()</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest</a></p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/auth#handlerequest" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/auth#handlerequest</a></p>
<p>You just created a new session for the newly created user and set a session cookie for them on the <code>local</code> object under the <code>auth</code> property.</p>
<p>This is where the session is set in the created cookie.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
<span class="token comment">// 2. create a new session once the user is created</span>
<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	userId<span class="token operator">:</span> user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
	attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Since we are on the <code>signup</code> page and submit a form the page reloads per web standards.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Learn/Forms/Sending_and_retrieving_form_data" target="_blank">MDN reference -&gt; Sending and retrieving form data</a></p>
<p>So once the page reloads and while we still have the session cookie stored in the app we can define a SvelteKit <code>load</code> function that has access to the <code>locals</code> object. Remember, on this <code>locals</code> object we added the <code>auth</code> property with this code.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>The <code>locals</code> object can be accessed in hooks, handle, and handleError, server-only load functions, and <code>+server.js</code> files.</p>
<p>It is important to understand that this <code>locals</code> object can be accessed by the mentioned functions, all of them being executed in a server-side context.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#loading-data" target="_blank">https://kit.svelte.dev/docs/form-actions#loading-data</a></p>
<p><strong>After a form action runs on a page, the page will be re-rendered (unless a redirect or an unexpected error occurs), with the action's return value available to the page as the form property.</strong></p>
<p><strong>This means that your page's load functions will run after the action completes.</strong></p>
<p>Since you do have a <code>load</code> function for the <code>signup</code> page <strong>YOU WANT THE LOAD FUNCTION TO RUN</strong> after the default form action.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/types#app-locals" target="_blank">https://kit.svelte.dev/docs/types#app-locals</a></p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/hooks#server-hooks-handle" target="_blank">https://kit.svelte.dev/docs/hooks#server-hooks-handle</a></p>
<p>Let's define a <code>load</code> function on the <code>signup</code> page and call the <code>validate</code> method on the <code>auth</code> property of the <code>locals</code> object.</p>
<p>The <code>validate</code> method returns a <code>Session</code> if the user is authenticated or <code>null</code> if not.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate</a></p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces#session" target="_blank">https://ucia-auth.com/reference/lucia/interfaces#session</a></p>
<p><strong>src/routes/signup/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// call the validate() method to check for a valid session</span>
	<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate</span>
	<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// we redirect the user to the profile page if the session is valid</span>
		<span class="token keyword keyword-throw">throw</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/profile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// default form action code follows..</span>

<span class="token comment">// when you submit the form the form action runs first..</span>

<span class="token comment">// then the page reload triggers the load function to run..</span>
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 009-protect-profile-page
</code></pre><h2 id="8-protect-profile-page">8. Protect Profile Page </h2>
<p>â— So far the <code>profile</code> page can be ðŸ˜± <strong>accessed publicly</strong> ðŸ˜± by every user of your app. â—</p>
<p>Let's change that.</p>
<p>You know that once a new user signs up there is a session being created. You can use this session to protect the <code>profile</code> page.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'PROFILE page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// call the validate() method to check for a valid session</span>
	<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate</span>
	<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// we redirect the user to the root/index/home page if the session is not valid</span>
		<span class="token keyword keyword-throw">throw</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'PROFILE page : session '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
			username<span class="token operator">:</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
			userId<span class="token operator">:</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
			sessionId<span class="token operator">:</span> session<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
			activePeriodExpiresAt<span class="token operator">:</span> session<span class="token punctuation">.</span>activePeriodExpiresAt<span class="token punctuation">,</span>
			state<span class="token operator">:</span> session<span class="token punctuation">.</span>state
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>Since you now redirect a newly signed up user from the <code>signup</code> page to the <code>profile</code> page you can either omit returning the created user to the <code>signup</code> page or just log the data.</p>
<p><strong>src/routes/signup/+page.server.ts</strong></p>
<p>Before</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// let's return the created user back to the sign up page for now</span>
<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>After</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SIGNUP page - form action : new user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Last not least, show the newly created user some private and user specific data on their <code>profile</code> page.</p>
<p>âš¡ â— This page is now private, cannot be accessed by public users, and is only visible after a successful signup of a new user and a successful creation of a new session. â— âš¡</p>
<p><strong>src/routes/profile/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword module keyword-import">import</span> type <span class="token punctuation">{</span> <span class="token maybe-class-name">PageData</span> <span class="token punctuation">}</span> <span class="token keyword module keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
	<span class="token keyword module keyword-export">export</span> <span class="token keyword keyword-let">let</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token maybe-class-name">PageData</span><span class="token punctuation">;</span>
	<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Profile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Account Details<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Protected Route - User Specific Information<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>

{#if Object.keys(data).length !== 0}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>{JSON.stringify(data, null, 2)}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
{/if}
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 010-login-user
</code></pre><h2 id="9-login-user">9. Login User </h2>
<p>In the next steps you are going to add the code needed to <strong>authenticate an existing user</strong> against their details in the database.</p>
<p>All of this is done server-side in the <strong>src/routes/login/+page.server.ts</strong> file.</p>
<h3 id="91-do-a-basic-check-with-the-received-form-values">9.1 Do a basic check with the received form values </h3>
<p>If the request couldn't be processed because of invalid data, you can return validation errors - along with the previously submitted form values - back to the user, so that they can try again.</p>
<p>The <code>fail</code> function lets you return an HTTP status code (typically <code>400</code> or <code>422</code>, in the case of validation errors) along with the data.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#anatomy-of-an-action-validation-errors" target="_blank">https://kit.svelte.dev/docs/form-actions#anatomy-of-an-action-validation-errors</a></p>
<p><strong>src/routes/login/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 011-authenticate-user
</code></pre><h3 id="92-authenticate-an-existing-user">9.2 Authenticate an Existing User </h3>
<p>Similar to the default <code>form action</code> for the <code>signup</code> page you have a default <code>form action</code> for the <code>login</code> page in a <code>+page.server.ts</code> file.</p>
<p>Now on the <code>login</code> page the user supplies an <code>username</code> and a <code>password</code> value.</p>
<p>ðŸ’¡ It is up to you to find a <code>user</code> in your database with those values.</p>
<p>ðŸ’¡ This is done with a <code>Key</code>.</p>
<p><strong>Keys represent the relationship between a user and a reference to that user.</strong></p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/basics/keys/" target="_blank">https://lucia-auth.com/basics/keys/</a></p>
<p><code>useKey()</code> accepts three parameters,</p>
<ul>
<li>the <code>providerId</code>, that is the "mechanism of authentication", so <code>username</code> or <code>email</code>, or <code>github</code> <a href="https://lucia-auth.com/basics/keys/#oauth" target="_blank">https://lucia-auth.com/basics/keys/#oauth</a>,</li>
<li>the <code>providerUserId</code>, that is the <code>username</code> or <code>email address</code>,</li>
<li>and as third parameter the <code>password</code>. <code>useKey()</code> checks if there is a user with such credentials in the database and returns a <code>key</code> if the <code>user</code> is found.</li>
</ul>
<p>While the user id is the primary way of identifying a user, there are other ways your app may reference a user during the authentication step such as by their <code>username</code>, <code>email</code>, or GitHub user id.</p>
<p>These identifiers, be it from a user input or an external source, are provided by a provider, identified by a provider id.</p>
<p>The unique id for that user within the provider is the provider user id.</p>
<p>The unique combination of the provider id and provider user id makes up a key.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-const">const</span> <span class="token function-variable function">useKey</span><span class="token operator">:</span> <span class="token punctuation">(</span>providerId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> providerUserId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Key<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre><p>ðŸ’¡ <a href="https://lucia-auth.com/basics/keys/#email--password" target="_blank">https://lucia-auth.com/basics/keys/#email--password</a></p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/auth/#usekey" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/auth/#usekey</a></p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit/#authenticate-users" target="_blank">https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit/#authenticate-users</a></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#usekey</span>
<span class="token comment">// find user by key and check if the password is defined and check if the password is correct/valid</span>
<span class="token keyword keyword-const">const</span> key <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">useKey</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>src/routes/login/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#usekey</span>
			<span class="token comment">// 1. find user by key and check if the password is defined and check if the password is correct/valid</span>
			<span class="token keyword keyword-const">const</span> key <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">useKey</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page - form action : key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>Go to the <code>login</code> page and submit the form.</p>
<p>Check your terminal.</p>
<p>ðŸ’¡ If the form with the correct <code>username</code> and <code>password</code> is submitted you can see the <code>key</code> that you log out.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>LOGIN page - form action <span class="token builtin class-name">:</span> key
<span class="token punctuation">{</span>
  providerId: <span class="token string">'username'</span>,
  providerUserId: <span class="token string">'cyber.punk.9731'</span>,
  userId: <span class="token string">'yf0ntwu2ik57dvq'</span>,
  passwordDefined: <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 012-create-user-session
</code></pre><h3 id="93-create-a-user-session">9.3 Create a User Session </h3>
<p>Sessions can be created with <code>Auth.createSession()</code> and can be stored as a cookie.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/auth#createsession" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</a></p>
<p>After successfully <strong>authenticating</strong> a user, weâ€™ll create a new session with <code>Auth.createSession()</code> and store it as a cookie with <code>AuthRequest.setSession()</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</a></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
<span class="token comment">// 2. create a new session once the user is created</span>
<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	userId<span class="token operator">:</span> key<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
	attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>â— Remember when you setup <code>hooks.server.ts</code> and stored the <code>Auth.request()</code> methods on the <code>locals.auth</code> object ? â—</p>
<p>ðŸ‘‰ <a href="https://github.com/robots4life/workshop-002-svelte-lucia-auth/tree/005-signup-user#54-setup-hooks-to-store-authrequest-on-the-localsauth-object" target="_blank">5.4 Setup Hooks to store Auth.request() on the locals.auth Object</a></p>
<p>Note that you can access the <code>locals</code> object where you stored the <code>auth</code> methods when creating the <code>hooks.server.ts</code> file.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#loading-data" target="_blank">https://kit.svelte.dev/docs/form-actions#loading-data</a></p>
<p>To access the <code>locals</code> object in a <code>load</code> function of a page or in a default or named <code>form action</code> of a page you need to add it as parameter to the function.</p>
<p>You can unpack properties from objects passed as a function parameter. These properties may then be accessed within the function body.</p>
<p>Here you see <code>locals</code> being added as a function parameter so that it can be accessed in the function body, in this case the <code>form action</code>.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment#unpacking_properties_from_objects_passed_as_a_function_parameter" target="_blank">MDN reference -&gt; Unpacking properties from objects passed as a function parameter</a></p>
<p><strong>src/routes/login/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#usekey</span>
			<span class="token comment">// 1. find user by key and check if the password is defined and check if the password is correct/valid</span>
			<span class="token keyword keyword-const">const</span> key <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">useKey</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page - form action : key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
			<span class="token comment">// 2. create a new session once the user is created</span>
			<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				userId<span class="token operator">:</span> key<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
			<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
			locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>Let's have a look at the terminal and observe the flow of data through your app.</p>
<p>ðŸ’¡ On the <code>login</code> page..</p>
<ol>
<li>the load function runs</li>
<li>then you submit the form</li>
<li>then the form action runs</li>
<li>Prisma deals with the query</li>
<li>then Lucia finds the <code>key</code></li>
<li>then Lucia sets the <code>session</code></li>
<li>Prisma deals with the query</li>
<li>last not least, the load function runs again as the page reloads after a form submit</li>
<li>you have an authenticated <code>user</code> and their <code>session</code> in your app</li>
</ol>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token operator">&gt;</span> workshop-002-svelte-lucia-auth@0.0.1 dev
<span class="token operator">&gt;</span> vite dev



  VITE v4.5.0  ready <span class="token keyword keyword-in">in</span> <span class="token number">938</span> ms

  âžœ  Local:   http://localhost:5173/
  âžœ  Network: use <span class="token parameter variable">--host</span> to expose
  âžœ  press h to show <span class="token builtin class-name">help</span>
<span class="token number">2023</span>-10-27T06:18:07.136Z
LOGIN page <span class="token builtin class-name">:</span> load <span class="token keyword keyword-function">function</span>
LOGIN page <span class="token builtin class-name">:</span> form action
FormData <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> name: <span class="token string">'username'</span>, value: <span class="token string">'cyber.punk.9731'</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span> name: <span class="token string">'password'</span>, value: <span class="token string">'12345678'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
prisma:query SELECT <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Key<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Key<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>hashed_password<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Key<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>user_id<span class="token variable">`</span></span> FROM <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Key<span class="token variable">`</span></span> WHERE <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Key<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> <span class="token operator">=</span> ? AND <span class="token assign-left variable">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> LIMIT ? OFFSET ?
LOGIN page - form action <span class="token builtin class-name">:</span> key
<span class="token punctuation">{</span>
  providerId: <span class="token string">'username'</span>,
  providerUserId: <span class="token string">'cyber.punk.9731'</span>,
  userId: <span class="token string">'yf0ntwu2ik57dvq'</span>,
  passwordDefined: <span class="token boolean">true</span>
<span class="token punctuation">}</span>
prisma:query BEGIN
prisma:query SELECT <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>User<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>User<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>username<span class="token variable">`</span></span> FROM <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>User<span class="token variable">`</span></span> WHERE <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>User<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> <span class="token operator">=</span> ? AND <span class="token assign-left variable">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> LIMIT ? OFFSET ?
prisma:query INSERT INTO <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Session<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>user_id<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>active_expires<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>idle_expires<span class="token variable">`</span></span><span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>?,?,?,?<span class="token punctuation">)</span> RETURNING <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> AS <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span>
prisma:query SELECT <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Session<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Session<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>user_id<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Session<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>active_expires<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Session<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>idle_expires<span class="token variable">`</span></span> FROM <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Session<span class="token variable">`</span></span> WHERE <span class="token variable"><span class="token variable">`</span>main<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>Session<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> <span class="token operator">=</span> ? LIMIT ? OFFSET ?
<span class="token number">2023</span>-10-27T06:18:10.794Z
LOGIN page <span class="token builtin class-name">:</span> load <span class="token keyword keyword-function">function</span>
prisma:query COMMIT
</code></pre><p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 013-handle-errors
</code></pre><h3 id="94-handle-errors">9.4 Handle Errors </h3>
<p>Lucia throws 2 types of errors: <code>LuciaError</code> and database errors from the database driver or ORM youâ€™re using.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/modules/main#luciaerror" target="_blank">https://lucia-auth.com/reference/lucia/modules/main#luciaerror</a></p>
<p>Most database related errors, such as connection failure, duplicate values, and foreign key constraint errors, are thrown as is. These need to be handled as if you were using just the driver/ORM.</p>
<p>Find details about how Prisma does error handling.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/concepts/components/prisma-client/handling-exceptions-and-errors" target="_blank">https://www.prisma.io/docs/concepts/components/prisma-client/handling-exceptions-and-errors</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference#error-codes" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference#error-codes</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/error-formatting" target="_blank">https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/error-formatting</a></p>
<p>Let's try and log a <code>PrismaClientKnownRequestError</code> with Prisma.</p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference#prismaclientknownrequesterror" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference#prismaclientknownrequesterror</a></p>
<p>ðŸ’¡ <a href="https://www.prisma.io/docs/reference/api-reference/error-reference#p2002" target="_blank">https://www.prisma.io/docs/reference/api-reference/error-reference#p2002</a></p>
<p>You should already have adjusted your Prisma module to <code>log</code> the <code>query</code> and <code>export</code> the <code>PrismaError</code> from Prisma Client.</p>
<p><strong>src/lib/server/prisma.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> Prisma<span class="token punctuation">,</span> PrismaClient <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@prisma/client'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> db <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">PrismaClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	log<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> PrismaError <span class="token operator">=</span> Prisma<span class="token punctuation">;</span>
</code></pre><p><strong>src/routes/login/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> LuciaError <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'lucia'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> PrismaError <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/prisma'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : form action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-const">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword keyword-const">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// basic check</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid username'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> password<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				message<span class="token operator">:</span> <span class="token string">'Invalid password'</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#usekey</span>
			<span class="token comment">// 1. find user by key and check if the password is defined and check if the password is correct/valid</span>
			<span class="token keyword keyword-const">const</span> key <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">useKey</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> username<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page - form action : key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
			<span class="token comment">// 2. create a new session once the user is created</span>
			<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				userId<span class="token operator">:</span> key<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
				attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
			<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
			locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//</span>
			<span class="token comment">// Prisma error</span>
			<span class="token comment">// https://www.prisma.io/docs/reference/api-reference/error-reference#prismaclientknownrequesterror</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>e <span class="token keyword keyword-instanceof">instanceof</span> <span class="token class-name">PrismaError</span><span class="token punctuation">.</span>PrismaClientKnownRequestError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">//</span>
				<span class="token comment">// https://www.prisma.io/docs/reference/api-reference/error-reference#p2002</span>
				<span class="token comment">// The .code property can be accessed in a type-safe manner</span>
				<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'P2002'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unique constraint failed on the </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token operator">?.</span>meta<span class="token operator">?.</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e : '</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e.meta : '</span> <span class="token operator">+</span> e<span class="token operator">?.</span>meta<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e.meta.target : '</span> <span class="token operator">+</span> e<span class="token operator">?.</span>meta<span class="token operator">?.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// return the error to the page with SvelteKit's fail function</span>
					<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unique constraint failed on the field </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token operator">?.</span>meta<span class="token operator">?.</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// Lucia error</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/modules/main#luciaerror</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>e <span class="token keyword keyword-instanceof">instanceof</span> <span class="token class-name">LuciaError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Lucia error</span>
				<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// throw any other error that is not caught by above conditions</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>To display the returned error <code>message</code> on the <code>login</code> page you <code>export</code> the <code>form</code> property on the page and work with the error.</p>
<p>Use the Svelte <code>class</code> directive to trigger the <code>.error</code> class on the <code>form</code> property.</p>
<p>ðŸ’¡ <a href="https://learn.svelte.dev/tutorial/classes" target="_blank">https://learn.svelte.dev/tutorial/classes</a></p>
<p><strong>src/routes/login/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token comment">// export the form property on this page to show the return value of the form action on the page</span>
	<span class="token keyword module keyword-import">import</span> type <span class="token punctuation">{</span> <span class="token maybe-class-name">ActionData</span> <span class="token punctuation">}</span> <span class="token keyword module keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
	<span class="token keyword module keyword-export">export</span> <span class="token keyword keyword-let">let</span> <span class="token literal-property property">form</span><span class="token operator">:</span> <span class="token maybe-class-name">ActionData</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/signup<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Sign Up With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Log In<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>32<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your Username<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cyber.punk.9731<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
		<span class="token attr-name">required</span>
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
		<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
		<span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
		<span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span>
		<span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Choose Your password<span class="token punctuation">"</span></span>
		<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12345678<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">form</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- show the return value from the form action --&gt;</span>
<span class="token comment">&lt;!-- use the Svelte class directive to trigger the CSS .error class --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> <span class="token attr-name"><span class="token namespace">class:</span>error</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{form?.message}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{JSON.stringify(form, null, 2)}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
	<span class="token selector">form</span> <span class="token punctuation">{</span>
		<span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
		<span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
		<span class="token property">gap</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token unit">rem</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token selector">button</span> <span class="token punctuation">{</span>
		<span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token selector"><span class="token class">.error</span></span> <span class="token punctuation">{</span>
		<span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token color">darkred</span><span class="token punctuation">;</span>
		<span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">lightgoldenrodyellow</span><span class="token punctuation">;</span>
		<span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span>
		<span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span> solid <span class="token color">darkslateblue</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>â— Change the form values to something that will break the validation to see the server-side check kick in. â—</p>
<img src="static/Screenshot_20231027_083813.png">
<p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 014-redirect-authenticated-user
</code></pre><h2 id="10-redirect-an-authenticated-user">10. Redirect an Authenticated User </h2>
<p>After an <strong>existing</strong> user has successfully logged in with their <code>username</code> and <code>password</code> on the <code>login</code> page it makes sense to <code>redirect</code> that user to another page of the app instead of staying on the <code>login</code> page.</p>
<p>For example we could redirect the new user to their personal <code>profile</code> page. Also, if a user tries to go back to the <code>login</code> page we should redirect them to their <code>profile</code> page instead.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit#redirect-authenticated-users" target="_blank">https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit#redirect-authenticated-users</a></p>
<p>In the previous step we did log in an <strong>existing</strong> user and a session for that user stored in a cookie. We will use the session stored in that cookie to authenticate the user on every new request to the app.</p>
<p>You can validate requests by creating a new <code>AuthRequest</code> instance with <code>Auth.handleRequest()</code>, which is stored in <code>locals.auth </code> and calling <code>AuthRequest.validate()</code>.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest</a></p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/auth#handlerequest" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/auth#handlerequest</a></p>
<p>You just created a new session for an <strong>existing</strong> user and set a session cookie for them on the <code>local</code> object under the <code>auth</code> property.</p>
<p>This is where the session is set in the created cookie.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth#createsession</span>
<span class="token comment">// 2. create a new session once the user is created</span>
<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	userId<span class="token operator">:</span> user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
	attributes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Since we are on the <code>login</code> page and submit a form the page reloads per web standards.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Learn/Forms/Sending_and_retrieving_form_data" target="_blank">MDN reference -&gt; Sending and retrieving form data</a></p>
<p>So once the page reloads and while we still have the session cookie stored in the app we can define a SvelteKit <code>load</code> function that has access to the <code>locals</code> object. Remember, on this <code>locals</code> object we added the <code>auth</code> property with this code.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#setsession</span>
<span class="token comment">// 3. store the session on the locals object and set session cookie</span>
locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>The <code>locals</code> object can be accessed in hooks, handle, and handleError, server-only load functions, and <code>+server.js</code> files.</p>
<p>It is important to understand that this <code>locals</code> object can be accessed by the mentioned functions, all of them being executed in a server-side context.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/form-actions#loading-data" target="_blank">https://kit.svelte.dev/docs/form-actions#loading-data</a></p>
<p><strong>After a form action runs on a page, the page will be re-rendered (unless a redirect or an unexpected error occurs), with the action's return value available to the page as the form property.</strong></p>
<p><strong>This means that your page's load functions will run after the action completes.</strong></p>
<p>Since you do have a <code>load</code> function for the <code>login</code> page <strong>YOU WANT THE LOAD FUNCTION TO RUN</strong> after the default form action.</p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/types#app-locals" target="_blank">https://kit.svelte.dev/docs/types#app-locals</a></p>
<p>ðŸ’¡ <a href="https://kit.svelte.dev/docs/hooks#server-hooks-handle" target="_blank">https://kit.svelte.dev/docs/hooks#server-hooks-handle</a></p>
<p>Let's define a <code>load</code> function on the <code>login</code> page and call the <code>validate</code> method on the <code>auth</code> property of the <code>locals</code> object.</p>
<p>The <code>validate</code> method returns a <code>Session</code> if the user is authenticated or <code>null</code> if not.</p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate</a></p>
<p>ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces#session" target="_blank">https://ucia-auth.com/reference/lucia/interfaces#session</a></p>
<p><strong>src/routes/login/+page.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LOGIN page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// call the validate() method to check for a valid session</span>
	<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate</span>
	<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// we redirect the user to the profile page if the session is valid</span>
		<span class="token keyword keyword-throw">throw</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/profile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// default form action code follows..</span>

<span class="token comment">// when you submit the form the form action runs first..</span>

<span class="token comment">// then the page reload triggers the load function to run..</span>
</code></pre><p>On the <code>login</code> page, submit the form and see how the logged in user is being redirected to their own profile page. Again you can see a session cookie is being created in your app.</p>
<img src="static/Screenshot_20231027_085221.png">
<p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 015-logout-user
</code></pre><h2 id="11-logout-user">11. Logout User </h2>
<p>Last not least, it is time to also log out an authenticated user. This could best be done on the <code>profile</code> page.</p>
<p>Add a form that will be handled by a default form action. There is no value that needs to be provided from the user.</p>
<p>Like you did before, handle the form submit with a default form action on the <code>profile</code> page.</p>
<p>To log out the user you need to..</p>
<ol>
<li>
<p>check if there is a session, if there is no session return a <code>401</code> error<br>
ðŸ’¡ <a href="https://en.wikipedia.org/wiki/HTTP_403" target="_blank">https://en.wikipedia.org/wiki/HTTP_403</a></p>
</li>
<li>
<p>if there is a session invalidate the user's session<br>
ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/auth/#invalidatesession" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/auth/#invalidatesession</a></p>
</li>
<li>
<p>remove the cookie with the session<br>
ðŸ’¡ <a href="https://lucia-auth.com/reference/lucia/interfaces/authrequest/#setsession" target="_blank">https://lucia-auth.com/reference/lucia/interfaces/authrequest/#setsession</a></p>
</li>
<li>
<p>â— redirect the user to the Home page of the app, or any other page that is NOT the <code>profile</code> page â—</p>
</li>
</ol>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> PageServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'PROFILE page : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// call the validate() method to check for a valid session</span>
	<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate</span>
	<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// we redirect the user to the root/index/home page if the session is not valid</span>
		<span class="token keyword keyword-throw">throw</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'PROFILE page : session '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
			username<span class="token operator">:</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
			userId<span class="token operator">:</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
			sessionId<span class="token operator">:</span> session<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
			activePeriodExpiresAt<span class="token operator">:</span> session<span class="token punctuation">.</span>activePeriodExpiresAt<span class="token punctuation">,</span>
			state<span class="token operator">:</span> session<span class="token punctuation">.</span>state
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> Actions <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> fail <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'$lib/server/lucia'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> actions<span class="token operator">:</span> Actions <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 1. check if there is a session, if there is NO session return a 401 error</span>
			<span class="token comment">// https://en.wikipedia.org/wiki/HTTP_403</span>
			<span class="token keyword keyword-return">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 2. if there is a session invalidate the user's session</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/auth/#invalidatesession</span>
			<span class="token keyword keyword-await">await</span> auth<span class="token punctuation">.</span><span class="token function">invalidateSession</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//3. remove the cookie with the session</span>
			<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest/#setsession</span>
			locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 4. redirect the user to the root/index/hom page of your app</span>
			<span class="token keyword keyword-throw">throw</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// redirect ALL other cases to the root/index/home page</span>
		<span class="token keyword keyword-throw">throw</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> satisfies Actions<span class="token punctuation">;</span>
</code></pre><p>Well done, you have come a long way and learned quite a bit.</p>
<p>Sit back, or stand up and stretch out, have a break, and enjoy what you have accomplished. ðŸŽ‰ ðŸš€</p>
<p>Now checkout the next branch.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> checkout 016-markup-session
</code></pre><h2 id="12-conditionally-show-markup-given-a-session">12. Conditionally show Markup given a Session </h2>
<p>Having the link to the <code>profile</code> page on the root/index/home page and showing that to logged out and public users does not make a lot of sense.</p>
<p>â— The <code>profile</code> page, as you now know, is protected and cannot be accessed by a public user. â—</p>
<p>However if you like to show a link <strong>to</strong> the <code>profile</code> page on the root/index/home page for <strong>logged in users</strong> you can do so with a condition in the markup.</p>
<p>Import the <code>data</code> property for that page and check in a condition if there is a <code>username</code> attached to it, show the link to the <code>profile</code> page only if the <code>data</code> property also has a <code>username</code> attached to it.</p>
<p><strong>src/routes/+page.svelte</strong></p>
<pre data-role="codeBlock" data-info="html" class="language-html html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword module keyword-import">import</span> type <span class="token punctuation">{</span> <span class="token maybe-class-name">PageData</span> <span class="token punctuation">}</span> <span class="token keyword module keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>
	<span class="token keyword module keyword-export">export</span> <span class="token keyword keyword-let">let</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token maybe-class-name">PageData</span><span class="token punctuation">;</span>
	<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'ROOT page : data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/signup<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Sign Up With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Log In With Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

{#if data.username}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/profile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>View Profile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
{/if}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Welcome to SvelteKit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Visit <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://kit.svelte.dev<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>kit.svelte.dev<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> to read the documentation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>But where does the data come from ?</p>
<p>Using a <code>+layout.server.ts</code> file in the <code>routes</code> directory of your app, so in the <code>src/routes</code> directory, you can pass data to all pages in that directory, so everything you load in a <code>+layout.server.ts</code> file will be available to all the pages/routes of that layout.</p>
<p>In <code>+layout.server.ts</code> you can check if there is a <code>session</code> and given that information <code>return</code> that data to the pages.</p>
<p>ðŸ’¡ Note, you do not have to return any sensitive <code>sessions</code> data, you could also just have a simple value instead of returning <code>session.user.username</code> to all pages of the layout, that is up to you and how you create your app.</p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
		loggedIn<span class="token operator">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>+layout.server.ts</strong></p>
<pre data-role="codeBlock" data-info="ts" class="language-ts ts"><code><span class="token keyword keyword-import">import</span> <span class="token keyword keyword-type">type</span> <span class="token punctuation">{</span> LayoutServerLoad <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'./$types'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> load<span class="token operator">:</span> <span class="token function-variable function">LayoutServerLoad</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> locals <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LAYOUT SERVER : load function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// call the validate() method to check for a valid session</span>
	<span class="token comment">// https://lucia-auth.com/reference/lucia/interfaces/authrequest#validate</span>
	<span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> locals<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LAYOUT SERVER : session '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
			username<span class="token operator">:</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>As an exercise you could now also <strong>only</strong> show the links to the <code>signup</code> and <code>login</code> page to public users and <strong>hide</strong> them for logged in users.</p>
<p>Give it a try, you can do it, I know it.</p>
<p>ðŸ’ª ðŸ˜„ ðŸš€ ðŸ’» ðŸ¤ž</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>